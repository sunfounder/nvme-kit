.. note::

    您好，欢迎加入 SunFounder 的 Raspberry Pi、Arduino 和 ESP32 爱好者 Facebook 社区！与志同道合的朋友一起深入探索 Raspberry Pi、Arduino 和 ESP32 的无限可能。

    **为什么加入？**

    - **专家支持**：在社区和官方团队的帮助下解决售后问题和技术难题。
    - **学习与分享**：交流技巧和教程，提升技能。
    - **独家预览**：抢先了解新产品发布和独家预览内容。
    - **专属折扣**：享受我们最新产品的专属优惠。
    - **节日促销与抽奖**：参与节日特别活动和抽奖。

    👉 准备好一起探索与创造了吗？点击 [|link_sf_facebook|] 立即加入！

.. _copy_sd_to_nvme_rpi:

将操作系统从 Micro SD 卡复制到 NVMe SSD
==================================================================

如果您已经拥有 NVMe SSD，但没有适配器将其连接到电脑，可以选择第三种方法：先将系统安装在 Micro SD 卡中。等 Raspberry Pi 5 成功启动后，再将系统从 Micro SD 卡迁移到 NVMe SSD。

* 首先，您需要 :ref:`install_os_sd_rpi`。
* 然后，启动并登录您的 Raspberry Pi。如果您不确定如何登录，可以访问官方 Raspberry Pi 网站：|link_rpi_get_start|。

完成上述步骤后，再继续以下操作。

1. 启用 PCIe
--------------------

默认情况下，PCIe 接口是未启用的。

* 要启用它，您需要打开 ``/boot/firmware/config.txt`` 文件。

  .. code-block:: shell
  
    sudo nano /boot/firmware/config.txt
  
* 然后在文件中添加以下内容：

  .. code-block:: shell
  
    # 启用外部 PCIe 接口
    dtparam=pciex1
  
* ``pciex1`` 有一个更容易记忆的别名，您也可以添加 ``dtparam=nvme`` 到 ``/boot/firmware/config.txt`` 文件中。

  .. code-block:: shell
  
    dtparam=nvme

* 该连接默认支持 Gen 2.0 速度（5 GT/秒），但您可以通过添加以下行强制使用 Gen 3.0（10 GT/秒）：

  .. code-block:: shell
  
    # 强制使用 Gen 3.0 速度
    dtparam=pciex1_gen=3
  
  .. warning::

    Raspberry Pi 5 并未对 Gen 3.0 速度进行认证，使用该速度连接 PCIe 设备可能会导致不稳定。

* 您还需要禁用 PCIe 启动延迟，以便 Raspberry Pi 在启动时可以检测到 PCIe Switch 后面的 NVMe 驱动器。请在 ``/boot/firmware/config.txt`` 文件中添加以下内容：

   .. code-block:: shell

      dtparam=pciex1_no_10s=on


* 按下 ``Ctrl + X``， ``Y``，然后 ``Enter`` 保存更改。



**BOOT_ORDER**

如果您安装了两个 NVMe 系统盘，并需要选择其中一个作为启动盘，
可以修改 ``/boot/firmware/cmdline.txt`` 文件中的 ``ROOT=PARTUUID=xxxxxxxxx`` 为您希望启动的磁盘的 UUID。您可以使用以下命令查找磁盘的 UUID：

.. code-block:: shell

   ls /dev/disk/by-id/


2. 在 SSD 上安装操作系统
----------------------------------------

有两种方式可以在 SSD 上安装操作系统：

**将系统从 Micro SD 卡复制到 SSD**

#. 连接显示器或通过 VNC Viewer 访问 Raspberry Pi 桌面。然后点击 **Raspberry Pi 图标** -> **附件 (Accessories)** -> **SD 卡复制器 (SD Card Copier)**。

   .. image:: img/ssd_copy.png
      

#. 确保正确选择 **从哪复制（Copy From）** 和 **复制到（Copy To）** 的设备。务必不要搞混。

   .. image:: img/ssd_copy_from.png
      

#. 勾选 “NEW Partition UUIDs”，确保系统能正确区分设备，避免挂载冲突和启动问题。

   .. image:: img/ssd_copy_uuid.png
   

#. 选择好后，点击 **Start**。

   .. image:: img/ssd_copy_click_start.png

#. 系统会提示 SSD 上的内容将被清除，请确保提前备份数据后再点击 Yes。

   .. image:: img/ssd_copy_erase.png

#. 等待一段时间，复制完成即可。


**使用 Raspberry Pi Imager 安装系统**

如果您的 Micro SD 卡中已安装桌面版系统，可以使用镜像工具（如 Raspberry Pi Imager）将系统烧录到 SSD。本例以 Raspberry Pi OS bookworm 为例，其他系统可能需要先安装镜像工具。

#. 连接显示器或通过 VNC Viewer 访问 Raspberry Pi 桌面。然后点击 **Raspberry Pi 图标** -> **附件 (Accessories)** -> **Imager**。

   .. image:: img/ssd_imager.png

      
#. 在 |link_rpi_imager| 中，点击 **Raspberry Pi Device**，从下拉列表中选择 **Raspberry Pi 5** 机型。

   .. image:: img/ssd_pi5.png
      :width: 90%


#. 选择 **操作系统（Operating System）**，推荐选择官方推荐的版本。

   .. image:: img/ssd_os.png
      :width: 90%
    
#. 在 **存储（Storage）** 选项中，选择您插入的 NVMe SSD。

   .. image:: img/nvme_storage.png
      :width: 90%
    
#. 点击 **NEXT** 然后选择 **EDIT SETTINGS** 以自定义操作系统设置。 

   .. note::

      如果您为 Raspberry Pi 连接了显示器，可以跳过接下来的设置，直接点击“是（Yes）”开始安装，其他设置稍后可在显示器上完成。

   .. image:: img/os_enter_setting.png
      :width: 90%

#. 设置一个 **主机名（hostname）** 给您的 Raspberry Pi。

   .. note::

      主机名是 Raspberry Pi 在网络中的标识，您可以通过 ``<hostname>.local`` 或 ``<hostname>.lan`` 访问它。

   .. image:: img/os_set_hostname.png
      

#. 创建一个 **用户名和密码**，用于 Raspberry Pi 的管理员账户。

   .. note::

      设置唯一的用户名和密码对于保护您的 Raspberry Pi 至关重要，因为它没有默认密码。

   .. image:: img/os_set_username.png
      

#. 配置无线网络，填写您的 **SSID（无线网络名）** 和 **密码**。

   .. note::

      请将 ``Wireless LAN country`` 设置为您所在国家的两位 `ISO/IEC alpha2 国家代码 <https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2#Officially_assigned_code_elements>`_。

   .. image:: img/os_set_wifi.png

#. 若需远程连接 Raspberry Pi，可在 **服务（Services）** 标签中启用 **SSH**。

   * 使用 **密码验证** 时，将使用“常规（General）”标签中的用户名和密码。
   * 若使用 **公钥验证**，请选择 "仅允许公钥验证（Allow public-key authentication only）"。如果您已有 RSA 密钥将直接使用；若没有，可点击 “Run SSH-keygen” 生成一对新的密钥。

   .. image:: img/os_enable_ssh.png
      

#. **选项（Options）** 菜单可配置 Imager 写入完成后的行为，如完成后播放提示音、弹出设备、启用遥测等。

   .. image:: img/os_options.png
    
#. 设置完成后，点击 **保存（Save）** 保存自定义设置。然后点击 **是（Yes）** 应用这些设置并开始写入镜像。

   .. image:: img/os_click_yes.png
      :width: 90%
      
#. 如果 NVMe SSD 中已有数据，请先备份以防数据丢失。如果不需要备份，可直接点击 **是（Yes）** 继续。

   .. image:: img/nvme_erase.png
      :width: 90%

#. 当您看到 “写入成功（Write Successful）” 弹窗时，说明镜像已写入并验证成功。您现在可以使用 NVMe SSD 启动 Raspberry Pi 啦！

   .. image:: img/nvme_install_finish.png
      :width: 90%

      

.. _configure_boot_ssd:

3. 配置从 SSD 启动
---------------------------------------

本节将指导您如何配置 Raspberry Pi 直接从 NVMe SSD 启动，从而比使用 SD 卡获得更快的启动速度和更好的性能。请按照以下步骤操作：

#. 首先，在 Raspberry Pi 上打开终端，运行以下命令以进入配置界面：

   .. code-block:: shell

      sudo raspi-config

#. 在 ``raspi-config`` 菜单中，使用方向键导航并选择 **高级选项（Advanced Options）**。按下 ``Enter`` 进入高级设置。

   .. image:: img/nvme_open_config.png

#. 在 **Advanced Options** 中，选择 **Boot Order** （启动顺序）。该设置允许您指定 Raspberry Pi 搜索可启动设备的顺序。

   .. image:: img/nvme_boot_order.png

#. 然后，选择 **NVMe/USB boot**。这会告诉 Raspberry Pi 优先从 USB 连接的 SSD 或 NVMe 驱动器启动，而不是从 SD 卡等其他设备启动。

   .. image:: img/nvme_boot_nvme.png

#. 选择好启动顺序后，按下 **Finish** 退出 raspi-config。您也可以使用 **Esc 键** 关闭配置工具。

   .. image:: img/nvme_boot_ok.png

#. 要应用新的启动设置，请运行以下命令重启 Raspberry Pi：

   .. code-block:: shell

      sudo reboot
   
   .. image:: img/nvme_boot_reboot.png

重启后，Raspberry Pi 应该会尝试从您连接的 NVMe SSD 启动，为系统提供更高的性能和更强的耐用性。
